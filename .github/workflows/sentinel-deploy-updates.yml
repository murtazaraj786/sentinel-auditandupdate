name: Deploy Sentinel Updates

on:
  # Manual trigger only for controlled deployments
  workflow_dispatch:
    inputs:
      deployment_mode:
        description: 'Deployment mode'
        required: true
        type: choice
        options:
          - auto
          - interactive
        default: 'interactive'
      update_type:
        description: 'Type of updates to deploy'
        required: true
        type: choice
        options:
          - all
          - analytic-rules
          - data-connectors
          - solutions
        default: 'all'

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy-updates:
    name: Deploy Sentinel Updates
    runs-on: ubuntu-latest
    environment: production  # Requires approval for production deployments
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Updates
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP_NAME: ${{ secrets.RESOURCE_GROUP_NAME }}
          WORKSPACE_NAME: ${{ secrets.WORKSPACE_NAME }}
        run: |
          if [ "${{ github.event.inputs.deployment_mode }}" == "auto" ]; then
            echo "ðŸš€ Auto-deploying updates..."
            python main.py --workflow --auto
          else
            echo "ðŸ“‹ Running interactive deployment (will require manual approval)..."
            python main.py --workflow
          fi
      
      - name: Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ github.run_number }}
          path: |
            deployment_report_*.txt
            deployment_results_*.csv
          retention-days: 90
      
      - name: Create Deployment Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ github.event.inputs.deployment_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Type**: ${{ github.event.inputs.update_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f deployment_report_*.txt ]; then
            echo "### Deployment Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat deployment_report_*.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
