name: Security Audit Suite (Sentinel & Defender XDR)

on:
  # Schedule to run daily at 9 AM UTC
  schedule:
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      run_basic_audit:
        description: 'Run basic Sentinel audit (connectors & rules)'
        required: false
        type: boolean
        default: true
      run_soc_optimization:
        description: 'Run SOC optimization analysis'
        required: false
        type: boolean
        default: true
      run_defender_xdr_audit:
        description: 'Run Defender XDR security audit'
        required: false
        type: boolean
        default: true
      export_csv:
        description: 'Export results to CSV'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  basic-audit:
    name: Basic Sentinel Audit
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_basic_audit != 'false' }}
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install basic audit dependencies
        working-directory: './Sentinel Audit'
        run: |
          python -m pip install --upgrade pip
          pip install -r simple_requirements.txt
      
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Run Basic Sentinel Audit
        working-directory: './Sentinel Audit'
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP_NAME: ${{ secrets.RESOURCE_GROUP_NAME }}
          WORKSPACE_NAME: ${{ secrets.WORKSPACE_NAME }}
          AUTH_MODE: 'default'  # Use Azure CLI credentials from login step
        run: |
          echo "Running basic Sentinel audit..."
          python sentinel_audit.py
      
      - name: Upload Basic Audit CSV Reports
        if: ${{ github.event.inputs.export_csv != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-basic-audit-${{ github.run_number }}
          path: |
            Sentinel Audit/*.csv
          retention-days: 30
          if-no-files-found: warn

  soc-optimization:
    name: SOC Optimization Analysis
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_soc_optimization != 'false' }}
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install SOC optimization dependencies
        working-directory: './Sentinel SOC Optimisation Audit'
        run: |
          python -m pip install --upgrade pip
          pip install -r soc_requirements.txt
      
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Run SOC Optimization Analysis
        working-directory: './Sentinel SOC Optimisation Audit'
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP_NAME: ${{ secrets.RESOURCE_GROUP_NAME }}
          WORKSPACE_NAME: ${{ secrets.WORKSPACE_NAME }}
          AUTH_MODE: 'default'  # Use Azure CLI credentials from login step
        run: |
          echo "Running SOC optimization analysis..."
          python soc_optimization_audit.py
      
      - name: Upload SOC Optimization CSV Reports
        if: ${{ github.event.inputs.export_csv != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-soc-optimization-${{ github.run_number }}
          path: |
            Sentinel SOC Optimisation Audit/*.csv
          retention-days: 30
          if-no-files-found: warn

  defender-xdr-audit:
    name: Defender XDR Security Audit
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_defender_xdr_audit != 'false' }}
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Defender XDR audit dependencies
        working-directory: './Defender XDR Audit'
        run: |
          python -m pip install --upgrade pip
          pip install -r xdr_requirements.txt
      
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Run Defender XDR Audit
        working-directory: './Defender XDR Audit'
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AUTH_MODE: 'default'  # Use Azure CLI credentials from login step
        run: |
          echo "Running Defender XDR security audit..."
          python defender_xdr_audit.py
      
      - name: Upload Defender XDR CSV Reports
        if: ${{ github.event.inputs.export_csv != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: defender-xdr-audit-${{ github.run_number }}
          path: |
            Defender XDR Audit/*.csv
          retention-days: 30
          if-no-files-found: warn
      
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [basic-audit, soc-optimization, defender-xdr-audit]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ›¡ï¸ Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sentinel Basic Audit**: ${{ github.event.inputs.run_basic_audit != 'false' && 'âœ… Completed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SOC Optimization**: ${{ github.event.inputs.run_soc_optimization != 'false' && 'âœ… Completed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Defender XDR Audit**: ${{ github.event.inputs.run_defender_xdr_audit != 'false' && 'âœ… Completed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Available Reports" >> $GITHUB_STEP_SUMMARY
          echo "- **Sentinel Basic**: Data connectors and analytic rules" >> $GITHUB_STEP_SUMMARY
          echo "- **SOC Optimization**: Rule efficiency, data ingestion, recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- **Defender XDR**: Security alerts, incidents, simulations, secure score" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check **Artifacts** section below for CSV downloads" >> $GITHUB_STEP_SUMMARY